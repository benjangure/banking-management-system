<div class="history-container">
  <mat-card class="history-card">
    <mat-card-header>
      <mat-card-title>
        <mat-icon>history</mat-icon>
        Transaction History
      </mat-card-title>
      <div class="export-buttons">
        <button mat-raised-button color="primary" (click)="downloadPDF()" matTooltip="Download PDF Report">
          <mat-icon>picture_as_pdf</mat-icon>
          PDF
        </button>
        <button mat-raised-button color="accent" (click)="downloadExcel()" matTooltip="Download Excel Report">
          <mat-icon>table_chart</mat-icon>
          Excel
        </button>
      </div>
    </mat-card-header>
    <mat-card-content>
      <!-- Filters -->
      <div class="filters">
        <mat-form-field class="filter-field">
          <mat-label>Select Account</mat-label>
          <mat-select [(ngModel)]="selectedAccount" (selectionChange)="onAccountChange()">
            <mat-option *ngFor="let account of userAccounts" [value]="account">
              {{ account.accountType }} - {{ account.accountNumber }}
            </mat-option>
          </mat-select>
        </mat-form-field>

        <mat-form-field class="filter-field">
          <mat-label>Transaction Type</mat-label>
          <mat-select [(ngModel)]="filterType" (selectionChange)="applyFilters()">
            <mat-option value="All">All Types</mat-option>
            <mat-option value="Deposit">Deposit</mat-option>
            <mat-option value="Withdrawal">Withdrawal</mat-option>
            <mat-option value="Transfer">Transfer</mat-option>
          </mat-select>
        </mat-form-field>

        <mat-form-field class="filter-field">
          <mat-label>Search</mat-label>
          <input matInput [(ngModel)]="searchText" (ngModelChange)="applyFilters()" placeholder="Transaction ID, description...">
          <mat-icon matSuffix>search</mat-icon>
        </mat-form-field>
      </div>

      <!-- Transactions Table -->
      <div class="table-container" *ngIf="filteredTransactions.length > 0; else noTransactions">
        <table mat-table [dataSource]="filteredTransactions" class="transaction-table">
          
          <!-- Date Column -->
          <ng-container matColumnDef="date">
            <th mat-header-cell *matHeaderCellDef>Date & Time</th>
            <td mat-cell *matCellDef="let transaction">
              {{ transaction.date | date:'short' }}
            </td>
          </ng-container>

          <!-- Type Column -->
          <ng-container matColumnDef="type">
            <th mat-header-cell *matHeaderCellDef>Type</th>
            <td mat-cell *matCellDef="let transaction">
              <div class="type-cell">
                <mat-icon class="type-icon" [class]="transaction.transactionType.toLowerCase()">
                  {{ transaction.transactionType === 'Deposit' ? 'add_circle' : 
                     transaction.transactionType === 'Withdrawal' ? 'remove_circle' : 'swap_horiz' }}
                </mat-icon>
                {{ transaction.transactionType }}
              </div>
            </td>
          </ng-container>

          <!-- Description Column -->
          <ng-container matColumnDef="description">
            <th mat-header-cell *matHeaderCellDef>Description</th>
            <td mat-cell *matCellDef="let transaction">
              <div class="description-cell">
                <div>{{ transaction.description }}</div>
                <div class="transaction-id">ID: {{ transaction.id }}</div>
              </div>
            </td>
          </ng-container>

          <!-- Amount Column -->
          <ng-container matColumnDef="amount">
            <th mat-header-cell *matHeaderCellDef>Amount</th>
            <td mat-cell *matCellDef="let transaction">
              <span class="amount" [ngClass]="getAmountClass(transaction)">
                {{ getAmountSign(transaction) }}KSh {{ transaction.amount | number:'1.2-2' }}
              </span>
            </td>
          </ng-container>

          <!-- Balance Column -->
          <ng-container matColumnDef="balance">
            <th mat-header-cell *matHeaderCellDef>Running Balance</th>
            <td mat-cell *matCellDef="let transaction">
              KSh {{ transaction.runningBalance | number:'1.2-2' }}
            </td>
          </ng-container>

          <!-- Status Column -->
          <ng-container matColumnDef="status">
            <th mat-header-cell *matHeaderCellDef>Status</th>
            <td mat-cell *matCellDef="let transaction">
              <mat-chip [color]="getStatusColor(transaction.status)">
                {{ transaction.status }}
              </mat-chip>
            </td>
          </ng-container>

          <!-- Actions Column -->
          <ng-container matColumnDef="actions">
            <th mat-header-cell *matHeaderCellDef>Actions</th>
            <td mat-cell *matCellDef="let transaction">
              <button mat-icon-button (click)="downloadReceipt(transaction)" matTooltip="Download Receipt">
                <mat-icon>receipt</mat-icon>
              </button>
            </td>
          </ng-container>

          <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
          <tr mat-row *matRowDef="let row; columns: displayedColumns;"></tr>
        </table>
      </div>

      <ng-template #noTransactions>
        <div class="no-data">
          <mat-icon>info</mat-icon>
          <p>No transactions found</p>
        </div>
      </ng-template>
    </mat-card-content>
  </mat-card>
</div>